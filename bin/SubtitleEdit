#!/bin/sh

set -e
#set -x

# See ~/tools/installs/SubtitleEdit/

# if [ "$WINEPREFIX" = "" ] ; then
#     if [ -d $HOME/.wine64clean ] ; then
# 	export WINEPREFIX=$HOME/.wine64clean
#     elif [ -d $HOME/.wine32 ] ; then
# 	export WINEPREFIX=$HOME/.wine32
#     fi
# fi
#export WINEPREFIX=${WINEPREFIX:-~/.wine}

# Can't just exec... SubtitleEdit will hang in defunct state because of improper garbage collection

if true ; then
    # Limit tesseract to use only 1 thread since SubtitleEdit will run multiple at a time
    export OMP_THREAD_LIMIT=1
    # No need to limit number of thread per CPU further... Default is 20 + MONO_THREADS_PER_CPU * NUM_CPUS
    #export MONO_THREADS_PER_CPU=0
    # Workaround a bug in mono with some old terminfo databases
    export TERM=xterm
    mono ~/tools/installs/SubtitleEdit/SubtitleEdit.exe "$@" &
else
    wine ~/tools/installs/SubtitleEdit/SubtitleEdit.exe "$@" &
fi
SUBTITLEEDIT_PID=$!
while true ; do
    psout=`ps --no-headers --pid $SUBTITLEEDIT_PID || true`
    if echo "$psout" | grep -q '<defunct>' ; then
        kill -9 $SUBTITLEEDIT_PID
        break
    elif [ -z "$psout" ] ; then
        break
    fi
    sleep 2
done
